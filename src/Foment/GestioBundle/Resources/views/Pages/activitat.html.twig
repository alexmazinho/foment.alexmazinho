{# src/Foment/GestioBundle/Resources/views/Page/activitat.html.twig #}
{% extends 'FomentGestioBundle::layout.html.twig' %}

{% form_theme form 'FomentGestioBundle:Includes:formtheming.html.twig' %}

{% block stylesheets %}
	<!-- Select2 styles -->
	<link href="{{ asset('css/select2.css') }}" type="text/css" rel="stylesheet" />
	
	{{ parent() }}
{% endblock %}

{% block title %}Gestió de dades dels cursos, tallers i activitats{% endblock %}

{% block breadcrumb %}
<li><a href="{{ path('foment_gestio_homepage') }}"><span class="fa fa-home fa-1x"></span> Inici</a></li><li><a href="{{ path('foment_gestio_activitats') }}">Cursos i activitats</a></li><li><span class="current">Edició</span></li>
{% endblock %}

{% block containerclass %}activitat-page{% endblock %}

{% block pagetitle %}Informació del curs, taller o activitat{% endblock %}

{% block topbuttons %}
	<li><a id="mostrar-activitats" href="{{ path('foment_gestio_activitats') }}" title="Mostrar llista cursos, tallers i activitats"><span class="button-icon icon-btn-40x40 list persian"></span>
		<span class="button-text">llista</span></a></li>
	<li><a id="export-activitat" href="{{ path('foment_gestio_exportparticipantsactivitat', {'id': activitat.id }) }}" target="_blank"  title="Exportar llista participants"><span class="button-icon icon-btn-40x40 spreadsheet green"></span>
		<span class="button-text">exportar</span></a></li>
	<li><a id="info-activitat" href="{{ path('foment_gestio_pdfactivitat', { 'activitat' : activitat.id } ) }}" title="Generar informe activitat i assistència" target="_blank"><span class="button-icon icon-btn-40x40 pdf red"></span>
		<span class="button-text">info</span></a></li>
	<li><a id="save-data" href="javascript:void(0)"><span class="button-icon icon-btn-40x40 confirm green"></span>
		<span class="button-text">desar</span></a></li>
	<li><a id="remove-item" href="{{ path('foment_gestio_esborraractivitat', {'id': activitat.id }) }}" title="Esborrar curs, taller o activitat"><span class="button-icon icon-btn-40x40 remove red"></span>
		<span class="button-text">eliminar</span></a></li>
{% endblock %}


{% block main %}
<div id="block-form-activitat">
	{{ form_start(form, {'action': path('foment_gestio_activitat')}) }}
	
	{% include 'FomentGestioBundle:Includes:messages.html.twig' %}
	
	<div class="form-block row">
		<div class="form-subblock col-md-12">
			<div class="row">{{ form_widget(form.id) }}
				<div class="form-field col-md-5 col-sm-12 resizable on-sidebar-col-md-12">
				    <div class="input-group"><span class="input-group-addon">descripcio</span>
				       	{{ form_widget(form.descripcio, {'attr': {'placeholder': '', 'class': 'form-control' } })  }}</div>{{ form_errors(form.descripcio) }}
				</div>
		        {{  form_widget(form.curs) }}
		        <div class="form-field col-md-2 col-sm-4 col-xs-6 resizable on-sidebar-col-md-4">
		        	<div class="input-group"><span class="input-group-addon input-group-addon-short">preu</span>{{ form_widget(form.quotaparticipant, {'attr': {'placeholder': '', 'class': 'form-control form-control-right' } })  }}
	    	    		<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>{{ form_errors(form.quotaparticipant) }}
		        </div>
		        <div class="form-field col-md-2 col-sm-4 col-xs-6 resizable on-sidebar-col-md-4">
		        	<div class="input-group"><span class="input-group-addon input-group-addon-short">no soci</span>{{ form_widget(form.quotaparticipantnosoci, {'attr': {'placeholder': '', 'class': 'form-control form-control-right' } })  }}
	    	    		<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>{{ form_errors(form.quotaparticipantnosoci) }}
		        </div>
		   	</div>
		</div>
		
		<div class="form-subblock col-md-12">
			<div id="info-panel" class="panel panel-default taula-formulari">
				<div class="panel-heading"><span  class="blue-title">Informacio i Facturació</span><a href="#tab1-informacio" class="show-hide-block"><span class="fa fa-minus-square-o fa-1 blue"></span></a></div>
				<div class="panel-body">
					<div class="row">	
						<div class="form-field col-md-2">
							<div class="input-group"><span class="input-group-addon input-group-addon-short">màx.</span>{{ form_widget(form.maxparticipants, {'attr': {'placeholder': '', 'class': 'form-control form-control-center' } })  }}
	    	    				<span class="input-group-addon input-group-addon-icon"><span class="fa fa-users fa-1x"></span></span>
	    	    			</div>{{ form_errors(form.maxparticipants) }}
						</div>
						<div class="form-field col-md-2">
		    				<div class="input-group"><span class="input-group-addon input-group-addon-short">hores</span>{{ form_widget(form.totalhores, {'attr': {'placeholder': '', 'class': 'form-control form-control-center' } })  }}
	    	    				<span class="input-group-addon input-group-addon-icon"><span class="fa fa-clock-o fa-1x"></span></span>
	    	    			</div>{{ form_errors(form.totalhores) }}
		    			</div>
		        		<div class="form-field col-md-3">
		        			<div class="input-group"><span class="input-group-addon input-group-addon-short">despeses</span>{{ form_widget(form.estimadespeses, {'attr': {'placeholder': '', 'class': 'form-control form-control-right' } })  }}
	    	    				<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span>
	    	    			</div>{{ form_errors(form.estimadespeses) }}
		        		</div>
		        		<div class="col-md-5">
		        			<span class="fa fa-users fa-1x"></span> preu orientatiu per {{ activitat.maxparticipants }}&nbsp;participants <span class="blue-title">{{ activitat.getPreuOrientatiu }} </span></span>
		        		</div>	        		
		        		<div class="form-field col-md-6">
		        			<div class="input-group"><span class="input-group-addon">lloc</span>
				       			{{ form_widget(form.lloc, {'attr': {'placeholder': '', 'class': 'form-control', 'rows': 2 } })  }}
				       		</div>{{ form_errors(form.lloc) }}
		        		</div>
		        		<div class="form-field col-md-6">
		        			<div class="input-group"><span class="input-group-addon">observacions</span>
			        			{{ form_widget(form.observacions, {'attr': {'placeholder': '', 'class': 'form-control', 'rows': 2  } })  }}
		        			</div>{{ form_errors(form.observacions) }}
		        		</div>
		        	</div>
					<div class="row">
						<div class="col-md-12"><span  class="blue-title">Facturacions</span></div>
						<div class="col-md-12">
							<div id="facturacions-curs" class="panel panel-default taula-resultats">
								<table class="table">
									<thead><tr><th colspan="3" class="hidden-col">&nbsp;</th> 
										<th class="table-field-left hfacturaciocurs-desc">descripció</th>
										<th class="table-field-right hfacturaciocurs-import">import</th>
										<th class="table-field-right hfacturaciocurs-importnosoci">no soci</th>
										<th class="table-field-center hfacturaciocurs-data">data</th>
										<th class="table-field-center hfacturaciocurs-docencia">planificació</th>
										<th class="table-field-center hfacturaciocurs-rebuts">rebuts</th>
										<th class="table-field-center hfacturaciocurs-icones">&nbsp;</th></tr>
									</thead>
									<tbody data-prototype-datafacturacio="{{ form_widget(form.facturacions.vars.prototype.datafacturacio, {'attr': {'class': 'form-control form-control-center' }, 'value' : queryparams['dataproto']|date("d/m/Y") })|e }}" 
											data-prototype-importactivitat="{{ form_widget(form.facturacions.vars.prototype.importactivitat, {'attr': {'class': 'form-control form-control-right' }, 'value': "0,00" })|e }}" 
											data-prototype-importactivitatnosoci="{{ form_widget(form.facturacions.vars.prototype.importactivitatnosoci, {'attr': {'class': 'form-control form-control-right', 'value': "0,00" } })|e }}" 
											data-prototype-descripcio="{{ form_widget(form.facturacions.vars.prototype.descripcio, {'attr': {'class': 'form-control form-control-left' }, 'value' : queryparams['descproto'] })|e }}"
											data-prototype-checkrebuts="crear-los {{ form_widget(form.facturacions.vars.prototype.checkrebuts, {'attr': {'class': 'form-control form-control-left checkbox checkbox-under' }, 'value' : '0' })|e }}"
											data-prototype-ordinals="{{ queryparams['ordinalsproto'] }}">
										<tr class="table-row-added table-row-prototype" >
											<td class="hidden-col facturaciocurs-id">&nbsp;</td>
											<td class="table-field-left facturaciocurs-desc"></td>
											<td class="table-field-right facturaciocurs-import">
												<div class="input-group">
													<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>
											</td>
											<td class="table-field-right facturaciocurs-importnosoci">
												<div class="input-group">
													<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>
											</td>
											<td class="table-field-center facturaciocurs-data">
												<div class="input-group">
													<span class="input-group-addon input-group-addon-icon open-calendar"><span class="fa fa-calendar fa-1x"></span></span></div>
											</td>
											<td class="table-field-center facturaciocurs-calendari">
												<a class="obrir-calendari" href="{{ path('foment_gestio_carregarcalendari', {'id': 0 }) }}" title="Obrir planificació">
													<span class="fa fa-graduation-cap fa-1x orange"></span>
												</a>
											</td>
											<td class="table-field-center facturaciocurs-rebuts">&nbsp;</td>
											<td class="facturaciocurs-icones icon-cell">
												<a class="esborrar-facturacio" href="javascript:void(0)" title="esborrar facturació"><span class="fa fa-remove fa-1x red"></span></a>
											</td>
										</tr>
										{% if activitat.id > 0 %}
											{% for facturacio in activitat.facturacionsactives %}
												<tr class="facturacio-row" >
													<td class="hidden-col facturaciocurs-id">{{ facturacio.id }}</td>
													<td class="table-field-left facturaciocurs-desc">{{ facturacio.descripcio }}</td>
													<td class="table-field-right facturaciocurs-import">{{ facturacio.importactivitat is empty ? '--': facturacio.importactivitat|number_format(2, ',', '.') }} €</td>
													<td class="table-field-right facturaciocurs-importnosoci">{{ facturacio.importactivitatnosoci is empty ? '--': facturacio.importactivitatnosoci|number_format(2, ',', '.') }} €</td>
													<td class="table-field-center facturaciocurs-data">{{ facturacio.datafacturacio is empty ? '': facturacio.datafacturacio|date('d/m/y') }}</td>
													<td class="table-field-center facturaciocurs-calendari">
														<a class="obrir-calendari" href="{{ path('foment_gestio_carregarcalendari', {'id': facturacio.id }) }}" title="Obrir planificació">
															<span class="fa fa-graduation-cap fa-1x orange"></span>
														</a>
													</td>
													<td class="table-field-center facturaciocurs-rebuts">
														{% if (facturacio.totalrebuts > 0) %}
															{{ facturacio.totalrebuts }}
														{% else %}
															<a class="crear-rebuts" href="{{ path('foment_gestio_crearrebuts', {'id': facturacio.id }) }}" title="crear rebuts de la facturació"><span class="fa fa-plus-circle fa-1 persian"></span></a>
														{% endif %}
													</td>
													<td class="facturaciocurs-icones icon-cell">
														<a class="cercar-rebuts" href="{{ path('foment_gestio_rebuts', {'facturacio': facturacio.id }) }}" title="rebuts de la facturació"><span class="fa fa-search fa-1 persian"></span></a>
														{% if facturacio.esEsborrable == true %}
															<a class="esborrar-facturacio" href="javascript:void(0)" title="esborrar facturació"><span class="fa fa-remove fa-1x red"></span></a>
														{% endif %}
													</td>
												</tr>
											{% endfor %}
										{% endif %}
										{% for facturacio in form.facturacions %}
											<tr class="facturacio-row table-row-added" >
												<td class="hidden-col facturaciocurs-id"></td>
												<td class="table-field-left facturaciocurs-desc">{{ form_widget(facturacio.descripcio, {'attr': {'class': 'form-control form-control-left' } }) }}</td>
												<td class="table-field-right facturaciocurs-import">
													<div class="input-group">{{ form_widget(facturacio.importactivitat, {'attr': {'class': 'form-control form-control-right' } }) }}
														<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>
												</td>
												<td class="table-field-right facturaciocurs-importnosoci">
													<div class="input-group">{{ form_widget(facturacio.importactivitatnosoci, {'attr': {'class': 'form-control form-control-right' } }) }}
														<span class="input-group-addon input-group-addon-icon"><span class="fa fa-eur fa-1x"></span></span></div>
												</td>
												<td class="table-field-center facturaciocurs-data">
													<div class="input-group">{{ form_widget(facturacio.datafacturacio, {'attr': {'class': 'form-control form-control-center datafacturacio-rowadded' } }) }}
														<span class="input-group-addon input-group-addon-icon open-calendar"><span class="fa fa-calendar fa-1x"></span></span></div>	
												</td>
												<td class="table-field-center facturaciocurs-calendari">
													<a class="obrir-calendari" href="{{ path('foment_gestio_carregarcalendari', {'id': facturacio.vars.id }) }}" title="Obrir planificació">
														<span class="fa fa-graduation-cap fa-1x orange"></span>
													</a>
												</td>
												<td class="table-field-center facturaciocurs-rebuts">
													crear-los {{ form_widget(facturacio.checkrebuts, {'attr': {'class': 'form-control form-control-center checkbox checkbox-under' } }) }}
												</td>
												<td class="facturaciocurs-icones icon-cell">
													<a class="esborrar-facturacio" href="javascript:void(0)" title="esborrar facturació"><span class="fa fa-remove fa-1x red"></span></a>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
								{{ form_widget(form.facturacionsdeltemp) }}
							</div>
						</div>
					</div>
					<div class="form-control-right"><a id="add-facturacio" href="javascript:void(0)">afegir&nbsp;<span class="fa fa-plus-circle fa-1x"></span></a></div>
				</div>
		   	</div>
		</div>
	</div>
	<div class="hr"></div>
	<div class="form-block row">
		<div class="form-subblock col-md-12">
		{% if (activitat.id > 0) %}
			<h2 class="block-title ">llista de participants</h2>
			<div class="row">
				<div class="col-md-6 col-xs-12">
					<div class="form-field full-width-container icon-container">
						{{ form_widget(form.participant, {'attr': {'placeholder': '', 'class': 'form-participant' } }) }}
						<a id="inscriure-action" href="{{ path('foment_gestio_activitatinscripcio', { id : activitat.id } ) }}"><span class="button-icon icon-btn-30x30 down blue"></span></a>
					</div>
				</div>
			</div>
			<div id="taula-participants">
			{% include 'FomentGestioBundle:Includes:taulaparticipantsactivitat.html.twig' %}
			</div>
		{% endif %}
		</div>
	</div>
	
	<div class="form-hidden">
    	{{ form_end(form) }}
    </div>		
	
</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}

	<!-- Select2 plugin's -->
	<script src="{{ asset('js/select2.min.js') }}" type="text/javascript"></script>
	<script src="{{ asset('js/select2_locale_ca.js') }}" type="text/javascript"></script>
	
	<script type="text/javascript">

	/***** Selector persones *****/
	var text = 'vols afegir en/na __NOM__ a l\'activitat?';
	text += '\n<i>per finalitzar tanca la finestra</i>';
	var titol = 'Afegir persona a l\'activitat';
	
	var $collectionHolder;
	
	$(document).ready( function() {

		var maxdate = new Date();
		maxdate.setDate(dateNow.getDate() + 365);

		// Taula d'activitats 
		{% set queryparamsc = queryparams|merge({ 'id': activitat.id, 'perpage': '__PERPAGE__', 'filtre': '__FILTRE__'}) %}

		var url = '{{ path('foment_gestio_activitat', queryparamsc)|raw }}';
		
		preparePaginatedSortedTable('#taula-participants', url, ajaxTaulaCallback); 

		$('a#save-data').click(function(event) {
			event.preventDefault();
			$('form').submit();
		});

		$('a#remove-item').click(function(event) {
			event.preventDefault();
			var url = $(this).attr('href');

			var text = "Segur que vols esborrar-ho? ";
			
			obrirDialegConfirmacio(text, "Confirmar esborrat", 0, 400, 
				function() { // Ok
					window.location = url;
				}, 
				function() { // Ko
					// Res a fer
				}
			);
		});

		/******************** PARTICIPANTS : Taula de participants *****************************/
		
		init_cercapersones_JSON('.form-participant', 'afegir participant (nom i/o cognoms)', {{ activitat.id }}, 0);

		$('a#inscriure-action').click(function(event) {
			
			event.preventDefault();
			
			if ($('input.form-participant').val() != '') {
				var participant_id = $('input.form-participant').val();
				var filtre = $('#taula-participants .filtre-text').val();
				var perpage = $('#taula-participants .select-midapagina').val()
				
				var url = $(this).attr('href') + '&perpage='+perpage+'&filtre='+filtre+'&persona=' + participant_id;

				ajaxTaulaCallback(url, '#taula-participants');
				//window.location = url;
			} else {
				obrirDialegInformacio('Cal seleccionar algun participant',  'Informació d\'error');
			}
			
		});

		// esdeveniment delegat pq s'actualitza l'element 
		$('#taula-participants').on('click', 'a#cancelar-action', function (event) {
			event.preventDefault();

			var filtre = $('#taula-participants .filtre-text').val();
			var perpage = $('#taula-participants .select-midapagina').val()
			var url = $(this).attr('href') + '&perpage='+perpage+'&filtre='+filtre;
			
			var text = "Segur que vols cancel·lar la inscripció? ";
			
			obrirDialegConfirmacio(text, "Confirmar cancel·lació", 0, 400, 
				function() { // Ok
					ajaxTaulaCallback(url, '#taula-participants');
					//window.location = url;
				}, 
				function() { // Ko
					// Res a fer
				}
			);
		});

		/******************************* FI PARTICIPANTS ****************************************/
		
		var maxdate = new Date();
		maxdate.setDate(dateNow.getDate() + (2*365));
		
		var finaldate = new Date();
		finaldate.setDate(dateNow.getDate() + 365);
		
		initDateTimePicker ($( '#form_datafacturacio' ), dateNow,  maxdate, finaldate, 'datafacturacio-picker', false);

		$( '.datafacturacio-rowadded' ).each(function( i ) {
			initDateTimePicker ($( this ), dateNow,  maxdate, finaldate, 'datafacturacio-picker-rowadded'+i, false);
		});

		/******************** CALENDARI : Planificació sessions *****************************/
		
		// Delegat, obrir calendari associat a la facturació
		$('#facturacions-curs').on('click', 'a.obrir-calendari', function (event) {
			event.preventDefault();
			
			var url = $(this).attr('href');
			
			$.get(url, function(data) {

				buttons = [{	
		           	text: "Afegir",
		           	id: "button-add-calendar",	
		            click: function() {
		            	// ??
		          	}
		          },
		          {	
			        text: "Desar",
			        id: "button-save-calendar",	
			        click: function() {
			        	// ??
		          	}
			      },
		          {	
			       	text: "Tancar",
			        click: function() {
			        	$( '#dialeg-informacio' ).dialog( "close" ); 
				 		$( '#dialeg-informacio' ).html('');
			       	}
			      }];
				
				obrirDialegCustom(data,  'Planificació', 0, 900, buttons, 'dialeg-calendari');

				// Tipus planificacions
				$( '.radio input.tipus-programacio[type="radio"]' ).change(function(e) {
					// data-value-init ==> Al pare
					var container = $(this).attr('container-data');

					$('.taula-programacio').hide();

					//alert(container);
					$(container).show();
					
				});
				
				$('#programacio-setmanal').show();
				$("#form_tipusprogramacio_0").prop("checked", true); // Radio button

				initDateTimePicker ($( '#form_datahorasessio' ), dateNow,  maxdate, finaldate, 'datahorasessio-picker', true);
				
				jQuery('.select-hora').datetimepicker({
					  datepicker:false,
					  format:'H:i'
				});

				
				init_cercapersones_JSON_noajax('#form_cercardocent', 'cercar docent: nom i/o cognoms', 2);


				// ********** AFEGIR PROGRAMACIÓ ************* 
				
				$('a#add-programacio').on('click', function(e) {
			        // prevent the link from creating a "#" on the URL
			        e.preventDefault();

					var url = $(this).attr('href');
			        
					// Sessió nova  ==> 'dd/mm/yyyy hh:ii+hh:ii;'
					if ($('#form_datahorasessio').val() != '' && $('#form_horafinalsessio').val() != '') {

						// Ok. Carregar sessió
						
						var sessionsCurrent = $('#form_persessions').val();
						if (sessionsCurrent != '') sessionsCurrent += ';';
						sessionsCurrent += $('#form_datahorasessio').val()+'+'+$('#form_horafinalsessio').val();
						$('#form_persessions').val(sessionsCurrent);

						// clean fields
						$('#form_datahorasessio').val('');
						$('#form_datahorasessio').removeClass('form-control-changed form-control-error');
						$('#form_horafinalsessio').val('');
						$('#form_horafinalsessio').removeClass('form-control-changed form-control-error');
					} else {
						if ($('#form_datahorasessio').val() != '' && $('#form_horafinalsessio').val() == '') {
							obrirDialegInformacio('La sessió està incompleta',  'Informació d\'error');
							$('#form_horafinalsessio').addClass('form-control-error');
							return false;
						}
						if ($('#form_datahorasessio').val() == '' && $('#form_horafinalsessio').val() != '') {
							obrirDialegInformacio('La sessió està incompleta',  'Informació d\'error');
							$('#form_datahorasessio').addClass('form-control-error');
							return false;
						}
					}
					// Mensual ==> 'diames+diasemana+hh:ii+hh:ii;'
					if ($('#form_setmanadelmes').val() != '' &&
						$('#form_diadelmes').val() != '' &&
						$('#form_horainicidiadelmes').val() != '' &&
						$('#form_horafinaldiadelmes').val() != '') {

						var mensualCurrent = $('#form_mensual').val();
						if (mensualCurrent != '') mensualCurrent += ';';
						mensualCurrent += $('#form_setmanadelmes').val()+'+';
						mensualCurrent += $('#form_diadelmes').val()+'+';
						mensualCurrent += $('#form_horainicidiadelmes').val()+'+';
						mensualCurrent += $('#form_horafinaldiadelmes').val();
						$('#form_mensual').val(mensualCurrent);

						// clean fields
						$('#form_setmanadelmes').val('');
						$('#form_setmanadelmes').parent('.form-select').removeClass('form-control-changed form-control-error');
						$('#form_diadelmes').val('');
						$('#form_diadelmes').parent('.form-select').removeClass('form-control-changed form-control-error');
						$('#form_horainicidiadelmes').val('');
						$('#form_horainicidiadelmes').removeClass('form-control-changed form-control-error');
						$('#form_horafinaldiadelmes').val('');
						$('#form_horafinaldiadelmes').removeClass('form-control-changed form-control-error');
					} else {
						if ($('#form_setmanadelmes').val() != '' ||
							$('#form_diadelmes').val() != '' ||
							$('#form_horainicidiadelmes').val() != '' ||
							$('#form_horafinaldiadelmes').val() != '') {

							if ($('#form_setmanadelmes').val() == '') {
								$('#form_setmanadelmes').parent('.form-select').addClass('form-control-error');
							}
							if ($('#form_diadelmes').val() == '') {
								$('#form_diadelmes').parent('.form-select').addClass('form-control-error');
							}
							if ($('#form_horainicidiadelmes').val() == '') {
								$('#form_horainicidiadelmes').addClass('form-control-error');
							}
							if ($('#form_horafinaldiadelmes').val() == '') {
								$('#form_horafinaldiadelmes').addClass('form-control-error');
							}

							obrirDialegInformacio('La programació mensual està incompleta',  'Informació d\'error');
							return false;
						}
					}
					
					// Setmanal ==> 'diasemana+hh:ii+hh:ii;'
					var backupSemanal = $('#form_setmanal').val();  // LA PROGRAMACIO SETMANAL SEMPRE ACTUALITZA LA EXISTENT, NO S'AFEGEIX
					$('#form_setmanal').val('');
					
					var res0 = programacioSetmanalDia($('#form_diessetmana_0'), $('#form_dlhorainici'), 
							$('#form_dlhorafinal'), 'dilluns');

					var res1 = programacioSetmanalDia($('#form_diessetmana_1'), $('#form_dmhorainici'), 
							$('#form_dmhorafinal'), 'dimarts');

					var res2 = programacioSetmanalDia($('#form_diessetmana_2'), $('#form_dxhorainici'), 
							$('#form_dxhorafinal'), 'dimecres');

					var res3 = programacioSetmanalDia($('#form_diessetmana_3'), $('#form_djhorainici'), 
							$('#form_djhorafinal'), 'dijous');

					var res4 = programacioSetmanalDia($('#form_diessetmana_4'), $('#form_dvhorainici'), 
							$('#form_dvhorafinal'), 'divendres');

					if (res0 && res1 && res2 && res3 && res4) { // Tot ok 
						url += '&persessions='+$('#form_persessions').val();
						url += '&mensual='+$('#form_mensual').val();
						url += '&setmanal='+$('#form_setmanal').val();

						url = url.replace(/\+/g,'%2B');  // El símbol '+' està reservat per representar l'espai
						
						// Get url and update $('#detall-programacio-setmanal') content
						$.get(encodeURI(url), function(data) {

							$('#detall-programacio-setmanal').html(data);
							
						}).fail(function(xhr, status, error) {
							$('#form_setmanal').val(backupSemanal);
							if (xhr.responseText != '') {
								mostrarErrorAjax('#programacio-setmanal', xhr.responseText);
							} else { 
								obrirDialegInformacio('Error mostrant la programació del curs',  'Informació d\'error');
							}
						});
					} else {
						$('#form_setmanal').val(backupSemanal);
					}
			    });


				// ********** TREURE PROGRAMACIÓ ************* 
				
				$('#detall-programacio-setmanal').on('click', 'a.treure-programa', function (event) {
					event.preventDefault();

					var originalProg = $(this).parent('td').siblings('.infoprograma-original').html();
					
					var strSessions = $('#form_persessions').val();
					var strMensual = $('#form_mensual').val();
					var strSetmanal = $('#form_setmanal').val();

					var trobat = false;
					if (strSessions.indexOf(originalProg) !== -1 && trobat == false) {
						strSessions = strSessions.replace(originalProg, '');
						strSessions = strSessions.replace(';;', ';');

						$('#form_persessions').val(strSessions);
						trobat = true;
					}
					if (strMensual.indexOf(originalProg) !== -1 && trobat == false) {
						strMensual = strMensual.replace(originalProg, '');
						strMensual = strMensual.replace(';;', ';');

						$('#form_mensual').val(strMensual);
						trobat = true;
					}
					if (strSetmanal.indexOf(originalProg) !== -1 && trobat == false) {
						strSetmanal = strSetmanal.replace(originalProg, '');
						strSeform_manal.replace(';;', ';');

						$('#form_setmanal').val(strSetmanal);
						trobat = true;
					}

					$parentRow = $(this).parents('tr');

					$parentRow.remove();

					if ($('#detall-programacio-setmanal tbody tr').length == 0) {
						$('#detall-programacio-setmanal tbody').append('<tr class="fila-error"><td colspan="5"><div class="alert"><div class="alert alert-success">no hi ha programada cap sessió</div></div></td></tr>');
					}
				});


				/****** AFEGIR DOCENTS ********/

				$('a#add-docent').on('click', function(e) {
			        // prevent the link from creating a "#" on the URL
			        e.preventDefault();

			        /*if ($('#form_preutotal').val() == "") {
			        	obrirDialegInformacio('El preu aproximat per docent és obligatori',  'Informació d\'error');
			        	$('#form_preutotal').addClass('form-control-error');
						return false;
					}*/

			        if ($('#form_cercardocent').val() == "") {
			        	obrirDialegInformacio('Cal escollir algun professor',  'Informació d\'error');
			        	$('#form_cercardocent').addClass('form-control-error');
						return false;
					}

			        $('.fila-error').remove();
			        
			        $collectionHolder = $('#taula-docencies .table tbody');

					var id = $('#form_cercardocent').val();

			        
			        var docentJSONObject = { 	"accio"		: "addNew",
			                               	    "proveidor"	: id, 
				                               	"preutotal"	: parseCurrencyAlex($('#form_preutotal').val()), 
				                               	"preuhora"	: parseCurrencyAlex($('#form_hores').val()),
				                               	"hores"		: $('#form_preuhora').val() };

			        var currentNewDocents = $('#form_docenciestmp').val(); // stringyfied
			        var currentJSONObjects = [];

			        if (currentNewDocents != '')  currentJSONObjects = JSON.parse(currentNewDocents);

			        currentJSONObjects.push(docentJSONObject); // Afeir nou registre

			        currentNewDocents =  JSON.stringify(currentJSONObjects); // Tornar a serialitza
			        
			        $('#form_docenciestmp').val(currentNewDocents);

			        $cloneProto = $('#taula-docencies tr.table-row-prototype').clone( );

			        $cloneProto.find('.profe-id').append($('#form_cercardocent').val());
			        $cloneProto.find('.profe-nom').append($('#select2-chosen-2').html());
			        $cloneProto.find('.profe-hores').append($('#form_hores').val());
			        $cloneProto.find('.profe-preu').append($('#form_preuhora').val());
			        $cloneProto.find('.profe-total').append($('#form_preutotal').val());

			        $cloneProto.removeClass('table-row-prototype');
					$cloneProto.addClass('docencia-row');

					$collectionHolder.append($cloneProto);
					
					// clean fields
					$('#form_cercardocent').val('');
					$('#select2-chosen-2').html('');
					$('#form_hores').val('');
					$('#form_preuhora').val('');
					$('#form_preutotal').val('');
					 
			        
			    });

				/****** TREURE DOCENTS ********/
				
				// Delegat, esborrar docent
				$('#taula-docencies').on('click', 'a.treure-docent', function (event) {
					event.preventDefault();

					$collectionHolder = $('#taula-docencies .table tbody');

					$parentRow = $(this).parents('tr');

					var currentNewDocents = $('#form_docenciestmp').val(); // stringyfied
					var currentJSONObjects = [];
			        if (currentNewDocents != '')  currentJSONObjects = JSON.parse(currentNewDocents);

			        var id = $parentRow.find('.profe-id').html(); 
					
					if ($parentRow.hasClass('table-row-added')) { // No desada, carregada jquery, treure la fila i prou
						$parentRow.remove();

						//alert(currentJSONObjects.length);
						
						// i treure del JSON form_docenciestmp
						var i = 0;
						var trobat = -1;
						while (i < currentJSONObjects.length && trobat == -1) {
							// Trobat 	
							if (currentJSONObjects[i].proveidor == id) trobat = i; 
							i++;
						}
						if (trobat != -1) {
							currentJSONObjects.splice(trobat,1); // Esborrar i desar novament
							currentNewDocents =  JSON.stringify(currentJSONObjects); // Tornar a serialitza
					        $('#form_docenciestmp').val(currentNewDocents);
						}
						
					} else {
						// Facturació existent. Afegir id a facturacionsdeltemp
						$parentRow.addClass('table-row-removed');	
						
						

						 // Carregar un array JSON amb les dades al camp "docenciestmp" per llegir en el POST
				        var docentJSONObject = {"accio"		: "remove",
				                               	"proveidor"	: id, 
					                            "preutotal"	: "", 
					                            "preuhora"	: "",
					                            "hores"		: "" };


			//alert(currentNewDocents);
				        
				        currentJSONObjects.push(docentJSONObject); // Afeir nou registre
				       	// if (currentNewDocents != '') currentNewDocents += ','; 


				        currentNewDocents =  JSON.stringify(currentJSONObjects); // Tornar a serialitza

			//alert(currentNewDocents);
				        
				        $('#form_docenciestmp').val(currentNewDocents);

					}

					if ($('#taula-docencies tbody tr.docencia-row').not('tr.table-row-removed').length == 0) {
						$('#taula-docencies tbody').append('<tr class="fila-error"><td colspan="6"><div class="alert"><div class="alert alert-success">no hi ha cap professor per al curs</div></div></td></tr>');
					}
				});


				/****** SCRIPTS PROVEIDORS ********/

				$('#planificacio-calendari-facturacio').on('click', 'a#show-add-docents', function (e) {
			        // prevent the link from creating a "#" on the URL
			        e.preventDefault();

			        url = $(this).attr('href');  

			        var currentdate = new Date();
					var maxBaixa = new Date();
					var minBaixa = new Date();
					minBaixa.setDate(currentdate.getDate() - 365);
					maxBaixa.setDate(currentdate.getDate() + 365);
			     // Get url and update $('#detall-programacio-setmanal') content
					$.get(encodeURI(url), function(data) {

						buttons = [{	
						           	text: "Afegir",
						           	id: "button-add-proveidor",	
						            click: function() {
						            	$( '#button-add-proveidor' ).hide();
						            	$( '#button-save-proveidor' ).show();
						            	$( '#taula-proveidors' ).hide('slide', {direction: 'down'}, 'slow', function() {
						            		$( '#formulari-proveidors' ).show('slide', {direction: 'top'}, 'slow');
							            });
						          	}
						          },
						          {	
							        text: "Desar",
							        id: "button-save-proveidor",	
							        click: function() {
							        	var url = $('form.form-proveidors').attr('action');  

										var params = $('form.form-proveidors').serializeArray();

										obrirMascaraBlock('#dialeg-informacio');
										
										$.post(url, params, function(data) {
											
											tancarMascaraBlock('#dialeg-informacio');
											$( '#formulari-proveidors' ).html(data);

											createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
											createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
											initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);
											
										}).fail(function(xhr, status, error) {
											createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
											createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
											initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);
											
											tancarMascaraBlock('#dialeg-informacio');
											var txtError = 'S\'ha produït un error desant les dades';
											if (xhr.responseText != '') txtError = xhr.responseText;
												
											mostrarErrorAjax('#dialeg-informacio', txtError);
										});
						          	}
							      },
						          {	
							       	text: "Tancar",
							        click: function() {
								 		if ( $('#proveidor_id').val() != '' && $('#proveidor_id').val() > 0) {
								 			$('#form_cercardocent').val( $('#proveidor_id').val() );
								 			init_cercapersones_JSON_noajax('#form_cercardocent', 'cercar docent: nom i/o cognoms', 2);
									 	}
							        	$( '#dialeg-informacio' ).dialog( "close" ); 
								 		$( '#dialeg-informacio' ).html('');
							       	}
							      }];

						obrirDialegCustom(data,  'Proveidors', 0, 650, buttons, 'dialeg-proveidors');

						createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
						createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
						initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);


						// Delegate event
						$( ".dialeg-proveidors" ).on( "click",  "a.mostrar-proveidor" ,function( e ) {
					        // prevent the link from creating a "#" on the URL
					        e.preventDefault();

					        url = $(this).attr('href');
					        obrirMascaraBlock('#dialeg-informacio');
							
							$.get(encodeURI(url), function(data) {
								tancarMascaraBlock('#dialeg-informacio');
								$( '#formulari-proveidors' ).html(data);
								
								createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
								createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
								initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);

								$( '#button-add-proveidor' ).hide();
				            	$( '#button-save-proveidor' ).show();
				            	$( '#taula-proveidors' ).hide('slide', {direction: 'down'}, 'slow', function() {
				            		$( '#formulari-proveidors' ).show('slide', {direction: 'top'}, 'slow');

				            		
					            }); 
								
							}).fail(function(xhr, status, error) {
								tancarMascaraBlock('#dialeg-informacio');
								var txtError = 'S\'ha produït un error desant les dades';
								if (xhr.responseText != '') txtError = xhr.responseText;
									
								mostrarErrorAjax('#dialeg-informacio', txtError);
							});
					        
							
						});

						// Delegate event
						$( ".dialeg-proveidors" ).on( "click",  "a.seleccionar-proveidor" ,function( e ) {
					        // prevent the link from creating a "#" on the URL
					        e.preventDefault();

					        var id = $(this).attr('data-id');

					 		if ( id != '' && id > 0) {
					 			$('#form_cercardocent').val( id );
					 			init_cercapersones_JSON_noajax('#form_cercardocent', 'cercar docent: nom i/o cognoms', 2);
						 	}
				        	$( '#dialeg-informacio' ).dialog( "close" ); 
					 		$( '#dialeg-informacio' ).html('');
						});

						// Delegate event
						/*$( ".dialeg-proveidors" ).on( "click",  ".pagination .page a" ,function( e ) {
					        // prevent the link from creating a "#" on the URL
					        e.preventDefault();

					        url = $(this).attr('href');
					        obrirMascaraBlock('#dialeg-informacio');
					        
					        $.get(encodeURI(url), function(data) {
								tancarMascaraBlock('#dialeg-informacio');

								$( '#dialeg-informacio' ).html(data);
								
								createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
								createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
								initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);
								
							}).fail(function(xhr, status, error) {
								tancarMascaraBlock('#dialeg-informacio');
								var txtError = 'S\'ha produït un error consultant les dades';
								if (xhr.responseText != '') txtError = xhr.responseText;
									
								mostrarErrorAjax('#dialeg-informacio', txtError);
							});
						});*/

						var urlTaula = $('#taula-proveidors').attr('data-link');
				
						preparePaginatedSortedTable('.dialeg-proveidors', urlTaula, ajaxTaulaDialegCallback);

						
					}).fail(function(xhr, status, error) {
						
						obrirDialegInformacio('Error mostrant la llista de proveidors',  'Informació d\'error');
					});
				 });    

				/****** FINAL SCRIPTS PROVEIDORS ********/
				
				
			}).fail(function(xhr, status, error) {
				if (xhr.responseText != '') {
					mostrarErrorAjax('#facturacions-curs', xhr.responseText);
				} else { 
					obrirDialegInformacio('Error obrint el calendari',  'Informació d\'error');
				}
			});
		});

		/*********************************** CALENDARI FI *************************************/
		
		
		
		/*******************************  FACTURACIONS ***********************************/
		
		// Afegir facturacions collection symfony2
		//http://symfony.com/doc/current/cookbook/form/form_collections.html#allowing-new-tags-with-the-prototype

		$collectionHolder = $('#facturacions-curs .table tbody');

    	$collectionHolder.data('index', $collectionHolder.find('.facturacio-row').length);
    	
    	// Crear facturació
		$('a#add-facturacio').on('click', function(e) {
	        // prevent the link from creating a "#" on the URL
	        e.preventDefault();
	        // add a new tag form (see next code block)
	        addTagForm($collectionHolder);
	    });

		// Delegat, esborrar facturació
		$('#facturacions-curs').on('click', 'a.esborrar-facturacio', function (event) {
			event.preventDefault();

			$collectionHolder = $('#facturacions-curs .table tbody');

			$parentRow = $(this).parents('tr');

			if ($parentRow.hasClass('table-row-added')) { // No desada, carregada jquery, treure la fila i prou
				$parentRow.remove();
			} else {
				// Facturació existent. Afegir id a facturacionsdeltemp
				$parentRow.addClass('table-row-removed');	
				
				var id = $parentRow.find('.facturaciocurs-id').html(); 
				
				var idscurrent = $('#form_facturacionsdeltemp').val();
				if (idscurrent != '') idscurrent += ',';
				idscurrent += id;
				$('#form_facturacionsdeltemp').val(idscurrent);
			}

			if ($('#facturacions-curs tbody tr.facturacio-row').not('tr.table-row-removed').length == 0) {
				$('#facturacions-curs tbody').append('<tr class="fila-error"><td colspan="5"><div class="alert"><div class="alert alert-success">no hi ha cap facturació per aquest curs</div></div></td></tr>');
			}
		});


		/******************************* FACTURACIONS FI *********************************/
		

		
		
	});

	ajaxTaulaDialegCallback = function(url, elemSel) {
		obrirMascaraBlock('#dialeg-informacio');

		var currentdate = new Date();
		var maxBaixa = new Date();
		var minBaixa = new Date();
		minBaixa.setDate(currentdate.getDate() - 365);
		maxBaixa.setDate(currentdate.getDate() + 365);
			
		$.get(encodeURI(url), function(data) {
			tancarMascaraBlock('#dialeg-informacio');

			$( '#dialeg-informacio' ).html(data);
			
			createSelects($('.poblacio-container .search-field'),'municipi', 'cercar població'); 
			createSelects($('.provincia-container .search-field'),'provincia', 'cercar provincia'); 
			initDateTimePicker ($( '#proveidor_databaixa' ), minBaixa, maxBaixa, currentdate, 'databaixa-picker', false);
			
		}).fail(function(xhr, status, error) {
			tancarMascaraBlock('#dialeg-informacio');
			var txtError = 'S\'ha produït un error consultant les dades';
			if (xhr.responseText != '') txtError = xhr.responseText;
				
			mostrarErrorAjax('#dialeg-informacio', txtError);
		});
	}
	
	function addTagForm($collectionHolder) {
		$('.fila-error').remove();
		
		var prototypeDatafacturacio = $collectionHolder.data('prototype-datafacturacio');
		var prototypeDescripcio = $collectionHolder.data('prototype-descripcio');
		var prototypeImportactivitat = $collectionHolder.data('prototype-importactivitat');
		var prototypeImportactivitatnosoci = $collectionHolder.data('prototype-importactivitatnosoci');
		var prototypeChecksrebuts = $collectionHolder.data('prototype-checkrebuts');
		var prototypeOrdinals = $collectionHolder.data('prototype-ordinals');
		
		var index = $collectionHolder.data('index');	    // get the new index
		
		var newDatafacturacioField = prototypeDatafacturacio.replace(/__name__/g, index); // Replace '__name__' in the prototype's HTML to
		var newDescripcioField = prototypeDescripcio.replace(/__name__/g, index); 
		var newImportactivitatField = prototypeImportactivitat.replace(/__name__/g, index);
		var newImportactivitatnosociField = prototypeImportactivitatnosoci.replace(/__name__/g, index);  
		var newChecksrebutsField = prototypeChecksrebuts.replace(/__name__/g, index);

		$cloneProto = $('#facturacions-curs tr.table-row-prototype').clone( );

		$cloneProto.removeClass('table-row-prototype');
		$cloneProto.addClass('facturacio-row');
		
		var tpId = $(newDatafacturacioField).attr('id');

		var ordinalsArray = prototypeOrdinals.split(",");
		var ordinalIndex = ordinalsArray[index + 1];
		var desc = ordinalIndex + ' ' + $(newDescripcioField).val();

		$cloneProto.find('.facturaciocurs-data .input-group').prepend(newDatafacturacioField);
		$cloneProto.find('.facturaciocurs-import .input-group').prepend(newImportactivitatField);
		$cloneProto.find('.facturaciocurs-importnosoci .input-group').prepend(newImportactivitatnosociField);
		$cloneProto.find('.facturaciocurs-rebuts').prepend(newChecksrebutsField);
		$cloneProto.find('.facturaciocurs-desc').append(newDescripcioField);

		// Canviar desc	
		$cloneProto.find('.facturaciocurs-desc input').val( desc );
		
	    $collectionHolder.data('index', index + 1);
	    
	    $collectionHolder.append($cloneProto);

	    var maxdate = new Date();
		maxdate.setDate(dateNow.getDate() + (2*365));
	    initDateTimePicker( $('#'+tpId) , dateNow,  maxdate, dateNow, 'datafacturacio-picker-'+index, false);
	    
	}

	function programacioSetmanalDia(elCheckDia, elHoraInici, elHorafinal, strDia) {
		if (elCheckDia.is(':checked') == true) {
			if (elHoraInici.val() == '' || elHorafinal.val() == '') {
				if (elHoraInici.val() == '') {
					elHoraInici.addClass('form-control-error');
				}
				if (elHorafinal.val() == '') {
					elHorafinal.addClass('form-control-error');
				}
				obrirDialegInformacio('Falta indicar dades de la sessió setmanal del '+strDia,  'Informació d\'error');
				return false;
			}

			var setmanalCurrent = $('#form_setmanal').val();
			if (setmanalCurrent != '') setmanalCurrent += ';';
			setmanalCurrent += elCheckDia.val()+'+';
			setmanalCurrent += elHoraInici.val()+'+';
			setmanalCurrent += elHorafinal.val();
			$('#form_setmanal').val(setmanalCurrent);

			elHoraInici.removeClass('form-control-changed form-control-error');
			elHorafinal.removeClass('form-control-changed form-control-error');
		}
		return true; 
	}

	//Definit també a persona
	callbackUpdateRebut = function () {
		var url = "{{ path('foment_gestio_activitat', {'id': activitat.id }|merge(queryparams)) |raw }}";
		window.location = url;
	}

	//Definit també a persona
	callbackRetornaRebut = function () {

		{% set queryparams = queryparams|merge({'retornats': true}) %}
		{% set queryparams = queryparams|merge({'tipus': constant('Foment\\GestioBundle\\Controller\\UtilsController::INDEX_FINES_RETORNAT')})  %}
		
		var url = "{{ path('foment_gestio_activitat', {'id': activitat.id }|merge(queryparams)) |raw }}";
		window.location = url;
	}

	</script>
	
	{% include 'FomentGestioBundle:Includes:taularebuts.js.twig' %}
{% endblock %}